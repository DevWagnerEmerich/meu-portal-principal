<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Usuários - Admin Educatech</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #111827;
            --main-bg: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --primary-color: #4F46E5;
            --primary-color-light: rgba(79, 70, 229, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); color: var(--text-primary); }
        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 260px; background-color: var(--sidebar-bg); padding: 1.5rem; display: flex; flex-direction: column; }
        .sidebar-header { color: #FFF; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; }
        .sidebar-nav .nav-link { color: #D1D5DB; font-size: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; align-items: center; }
        .sidebar-nav .nav-link.active, .sidebar-nav .nav-link:hover { background-color: #374151; color: #FFF; }
        .sidebar-nav .nav-link svg { margin-right: 1rem; width: 20px; height: 20px; }
        .sidebar-footer { margin-top: auto; }
        .main-content { margin-left: 260px; padding: 2rem; }
        .page-header { margin-bottom: 2rem; }
        .admin-card { background-color: var(--card-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.06); }
        .card-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 0; background: none; padding: 0; margin-bottom: 1rem; }
        .card-title { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }
        .chart-container { position: relative; height: 320px; width: 100%; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">Educatech</div>
        <ul class="nav flex-column sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="/admin">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                    Visão Geral
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/users">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962a3.75 3.75 0 015.25 0m-5.25 0a3.75 3.75 0 00-5.25 0M3 13.5g.75 0a.75.75 0 01.75.75v.608c0 .713.58 1.296 1.296 1.296h.608a.75.75 0 01.75.75v.75m-1.5-1.5l-1.5-1.5m0 0a2.25 2.25 0 013 0m-3 0a2.25 2.25 0 00-3 0m12 4.242V18a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-2.25m13.5-9g.75 0a.75.75 0 00.75-.75v-.608c0-.713-.58-1.296-1.296-1.296h-.608a.75.75 0 00-.75.75v.75m1.5 1.5l1.5-1.5m0 0a2.25 2.25 0 00-3 0m3 0a2.25 2.25 0 01-3 0m-7.5 9.25h9" /></svg>
                    Análise de Usuários
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/games">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15zM21 21l-5.197-5.197" /></svg>
                    Análise de Jogos
                </a>
            </li>
        </ul>
        <div class="sidebar-footer">
            <button id="logout-btn" class="btn btn-dark w-100">Sair</button>
        </div>
    </div>

    <main class="main-content">
        <div class="page-header">
            <h1 class="h2">Análise de Usuários</h1>
            <p class="text-secondary">Métricas detalhadas sobre aquisição e planos de usuários.</p>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="admin-card">
                    <div class="card-header"><div class="card-title">Novos Usuários (Últimos 30 dias)</div></div>
                    <div class="chart-container">
                        <canvas id="newUsersChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="admin-card">
                    <div class="card-header"><div class="card-title">Distribuição de Planos</div></div>
                    <div class="chart-container">
                        <canvas id="planDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function showToast(message, type = 'success') {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = `toast-${Date.now()}`;
                const toastHtml = `
                    <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                const toastEl = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
            const chartDefaults = {
                plugins: { legend: { display: false } },
                scales: { 
                    y: { ticks: { color: '#6B7280' }, grid: { display: false } },
                    x: { ticks: { color: '#6B7280' }, grid: { display: false } }
                },
                maintainAspectRatio: false,
                responsive: true
            };

            async function fetchData(endpoint) {
                const response = await fetch(`/api/admin/${endpoint}`);
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        showToast('Acesso negado. Redirecionando para o login...', 'danger');
                        setTimeout(() => window.location.href = '/login.html', 2000);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            // New Users Chart (Line)
            fetchData('metrics/users/new-daily').then(data => {
                if (!data) return;
                new Chart(document.getElementById('newUsersChart'), {
                    type: 'line',
                    data: {
                        labels: data.map(row => row.date),
                        datasets: [{
                            label: 'Novos Usuários',
                            data: data.map(row => row.newRegistrations),
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderColor: '#4F46E5',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: chartDefaults
                });
            }).catch(e => console.error("Erro no gráfico de novos usuários:", e));

            // Plan Distribution Chart (Doughnut)
            fetchData('metrics/subscriptions/plan-distribution').then(data => {
                if (!data) return;
                new Chart(document.getElementById('planDistributionChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.map(row => row.subscription_type),
                        datasets: [{
                            data: data.map(row => row.count),
                            backgroundColor: ['#4F46E5', '#818CF8', '#A78BFA', '#E5E7EB'],
                            borderWidth: 0
                        }]
                    },
                    options: { ...chartDefaults, plugins: { legend: { display: true, position: 'bottom' } } }
                });
            }).catch(e => console.error("Erro no gráfico de distribuição de planos:", e));

            // Logout button
            document.getElementById('logout-btn')?.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/logout', { method: 'POST' });
                    if (response.ok) window.location.href = '/login.html';
                    else alert('Erro ao fazer logout.');
                } catch (error) {
                    alert('Erro de rede ao fazer logout.');
                }
            });
        });
    </script>
</body>
</html>
